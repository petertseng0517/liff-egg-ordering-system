<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åœŸé›è›‹è¨‚è³¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #fffbf0; }
    .page { display: none; }
    .active { display: block; }
    .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 12px; }
    .btn-main { background-color: #e67e22; color: white; border-radius: 8px; font-weight: bold; }
    .btn-main:hover { background-color: #d35400; color: white; }
    .price-tag { color: #c0392b; font-weight: bold; font-size: 1.2rem; }
  </style>
</head>
<body>

  <div id="loading" class="text-center mt-5">
    <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 text-muted">ç³»çµ±å•Ÿå‹•ä¸­...</h4>
  </div>

  <div id="p-welcome" class="page text-center">
    <div class="card p-5">
        <h3 class="mb-3">æ­¡è¿å›ä¾†ï¼</h3>
        <h2 class="text-primary mb-4" id="welcome-name">æœƒå“¡</h2>
        <p class="text-muted">æ‚¨å·²ç¶“æ˜¯æˆ‘å€‘çš„æœƒå“¡äº†ã€‚</p>
        <div class="d-grid gap-2">
            <button class="btn btn-main btn-lg" onclick="location.href='/?page=order'">æˆ‘è¦è¨‚è›‹</button>
            <button class="btn btn-outline-secondary" onclick="location.href='/?page=history'">æŸ¥çœ‹ç´€éŒ„</button>
        </div>
    </div>
  </div>

  <div id="p-register" class="page">
    <div class="card p-4">
      <h3 class="mb-4 text-center">ğŸ£ æœƒå“¡è³‡æ–™å¡«å¯«</h3>
      <form id="form-register">
        <div class="mb-3"><label>æ‚¨çš„å§“å</label><input type="text" class="form-control" id="reg-name" required></div>
        <div class="mb-3"><label>å‡ºç”Ÿæ—¥æœŸ</label><input type="date" class="form-control" id="reg-birthdate"></div>
        <div class="mb-3"><label>è¯çµ¡é›»è©±</label><input type="tel" class="form-control" id="reg-phone" inputmode="tel" required></div>
        <div class="mb-3"><label>é…é€åœ°å€</label><input type="text" class="form-control" id="reg-address" required></div>
        <div class="mb-3"><label>ç¬¬äºŒé…é€åœ°å€ (é¸å¡«)</label><input type="text" class="form-control" id="reg-address2"></div>
        <button type="button" class="btn btn-main w-100 btn-lg py-3" onclick="submitRegister()">ç¢ºèªè¨»å†Š</button>
      </form>
    </div>
  </div>

  <div id="p-order" class="page">
    <div class="card p-4">
      <h3 class="mb-4 text-center">ğŸ¥š æˆ‘è¦è¨‚è›‹</h3>
      <form id="form-order">
        <div class="mb-3">
          <label>é¸æ“‡å•†å“</label>
          <select class="form-select form-select-lg" id="order-items" onchange="calcPrice()">
            <option value="åœŸé›è›‹11ç›¤" data-price="2500">åœŸé›è›‹ 11ç›¤ ($2500)</option>
            <option value="åœŸé›è›‹1ç›¤" data-price="250">åœŸé›è›‹ 1ç›¤ ($250)</option>
          </select>
        </div>
        <div class="mb-3">
          <label>æ•¸é‡</label>
          <div class="input-group input-group-lg">
            <button class="btn btn-outline-secondary" type="button" onclick="changeQty(-1)">-</button>
            <input type="number" class="form-control text-center" id="order-qty" value="1" min="1" readonly>
            <button class="btn btn-outline-secondary" type="button" onclick="changeQty(1)">+</button>
          </div>
        </div>
        <div class="mb-3">
          <label>å‚™è¨» (é¸å¡«)</label>
          <textarea class="form-control" id="order-remarks" rows="2" placeholder="ä¾‹å¦‚ï¼šè«‹ä¸‹åˆé…é€"></textarea>
        </div>

        <div class="mb-3">
            <label class="d-block mb-2">ä»˜æ¬¾æ–¹å¼</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="paymentMethod" id="pay-transfer" value="transfer" checked>
                <label class="form-check-label" for="pay-transfer">éŠ€è¡Œè½‰å¸³/è²¨åˆ°ä»˜æ¬¾</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="paymentMethod" id="pay-ecpay" value="ecpay">
                <label class="form-check-label" for="pay-ecpay">ç·šä¸Šæ”¯ä»˜ (ä¿¡ç”¨å¡/ATM)</label>
            </div>
        </div>

        <div class="alert alert-warning text-center">ç¸½é‡‘é¡: <span class="price-tag">$<span id="total-price">2500</span></span></div>
        <button type="button" class="btn btn-main w-100 btn-lg py-3" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
      </form>
    </div>
  </div>
  
  <div id="p-history" class="page">
    <h3 class="mb-3">ğŸ“œ è¨‚è³¼ç´€éŒ„</h3>
    <div id="history-list" class="list-group">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="p-success" class="page text-center">
    <div class="card p-5">
      <div class="mb-3" style="font-size: 4rem;">âœ…</div>
      <h3 class="mb-3">è¨‚å–®å·²æ”¶åˆ°ï¼</h3>
      <p class="text-muted">æ‚¨çš„è¨‚å–®ç·¨è™Ÿç‚ºï¼š</p>
      <h2 class="text-primary mb-4" id="success-order-id">ORD...</h2>
      <p>æˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨å®‰æ’é…é€ã€‚</p>
      <div class="d-grid gap-2">
        <button class="btn btn-outline-primary" onclick="location.href='/?page=history'">æŸ¥çœ‹è¨‚è³¼ç´€éŒ„</button>
        <button class="btn btn-outline-secondary" onclick="if(liff.isInClient()){liff.closeWindow();}else{location.href='/?page=order';}">é—œé–‰ / ç¹¼çºŒè¨‚è³¼</button>
      </div>
    </div>
  </div>

  <div id="p-register-success" class="page text-center">
    <div class="card p-5">
      <div class="mb-3" style="font-size: 4rem;">ğŸ‰</div>
      <h3 class="mb-3">è¨»å†ŠæˆåŠŸï¼</h3>
      <p class="text-muted">æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹è¨‚è³¼å•†å“äº†ã€‚</p>
      <div class="d-grid gap-2">
        <button class="btn btn-main" onclick="location.href='/?page=order'">å‰å¾€è¨‚è³¼é </button>
        <button class="btn btn-outline-secondary" onclick="if(liff.isInClient()){liff.closeWindow();}else{location.href='/?page=register';}">é—œé–‰ / è¿”å›è¨»å†Šé </button>
      </div>
    </div>
  </div>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    var MY_LIFF_ID = "2008795367-LqjjCaaQ"; 
    var userId = null; // åˆå§‹åŒ–ç‚º null
    var userName = "";

    // å•Ÿå‹•é‚è¼¯
    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
             // ç‚ºäº†æ–¹ä¾¿é–‹ç™¼ï¼Œå¦‚æœä½ åœ¨é›»è…¦ç€è¦½å™¨çœ‹ï¼Œå°±ä¸å¼·åˆ¶ç™»å…¥ LINE
             if(!liff.isInClient()) {
                console.log("é›»è…¦é–‹ç™¼æ¨¡å¼: ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ");
                userId = "TEST_USER_001"; // åªæœ‰åœ¨é›»è…¦ä¸”æœªç™»å…¥æ™‚æ‰ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ
                checkMemberStatus();
             } else {
                liff.login(); 
             }
          } else {
            liff.getProfile().then(profile => {
              userId = profile.userId;
              userName = profile.displayName;
              checkMemberStatus();
            }).catch(err => {
                console.error("GetProfile Error", err);
                document.getElementById('loading').innerHTML += '<p class="text-danger">ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™: ' + err + '</p>';
            });
          }
        })
        .catch(err => {
            console.log("LIFF Init Error:", err);
            // å°±ç®— LIFF å¤±æ•—ï¼ˆä¾‹å¦‚é›»è…¦æ²’é–‹æ¬Šé™ï¼‰ï¼Œä¹Ÿè®“ç•«é¢é¡¯ç¤ºå‡ºä¾†æ–¹ä¾¿æ¸¬è©¦
            document.getElementById('loading').innerHTML += '<p class="text-danger">LIFF åˆå§‹åŒ–å¤±æ•—: ' + err + '</p>';
            // å˜—è©¦ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ fallbackï¼Œæ–¹ä¾¿é›»è…¦é™¤éŒ¯ï¼Œä½†æ‰‹æ©Ÿä¸Šçœ‹åˆ°éŒ¯èª¤è¨Šæ¯æ¯”è¼ƒé‡è¦
            if(!liff.isInClient()) {
                userId = "TEST_USER_001";
                checkMemberStatus();
            }
        });
    };

    function checkMemberStatus() {
        if (!userId) return;

        // å¦‚æœç¶²å€æœ‰æŒ‡å®š pageï¼Œå°±ç›´æ¥å»è©²é é¢ï¼Œä¸æª¢æŸ¥æœƒå“¡ (ä¾‹å¦‚æƒ³ç›´æ¥çœ‹æ­·å²ç´€éŒ„)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('page')) {
            document.getElementById('loading').style.display = 'none';
            resolveRoute();
            return;
        }

        // å‘¼å«å¾Œç«¯æª¢æŸ¥æœƒå“¡ç‹€æ…‹
        fetch('/api/check_member', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            if (data.registered) {
                // å·²è¨»å†Š -> é¡¯ç¤ºæ­¡è¿é é¢
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('p-welcome').classList.add('active');
                document.getElementById('welcome-name').innerText = data.name;
            } else {
                // æœªè¨»å†Š -> é¡¯ç¤ºè¨»å†Šé é¢ (é è¨­è¡Œç‚º)
                resolveRoute();
            }
        })
        .catch(err => {
            console.error("Check member error:", err);
            document.getElementById('loading').style.display = 'none';
            resolveRoute();
        });
    }

    function resolveRoute() {
      const urlParams = new URLSearchParams(window.location.search);
      const page = urlParams.get('page') || 'register';
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
      
      if (page === 'register') {
        document.getElementById('p-register').classList.add('active');
        // if(document.getElementById('reg-name')) document.getElementById('reg-name').value = userName; // ç§»é™¤é è¨­å€¼
      } else if (page === 'order') {
        document.getElementById('p-order').classList.add('active');
      } else if (page === 'history') {
        document.getElementById('p-history').classList.add('active');
        loadHistory();
      }
    }

    // è¨ˆç®—åƒ¹æ ¼
    function changeQty(delta) {
      var input = document.getElementById('order-qty');
      var val = parseInt(input.value) + delta;
      if (val < 1) val = 1;
      input.value = val;
      calcPrice();
    }
    function calcPrice() {
      var price = parseInt(document.getElementById('order-items').selectedOptions[0].dataset.price);
      var qty = parseInt(document.getElementById('order-qty').value);
      document.getElementById('total-price').innerText = price * qty;
    }

    // === æ–°ç‰ˆï¼šä½¿ç”¨ fetch å‘¼å« Python API ===

    function submitRegister() {
        const payload = {
            userId: userId,
            name: document.getElementById('reg-name').value,
            birthDate: document.getElementById('reg-birthdate').value,
            phone: document.getElementById('reg-phone').value,
            address: document.getElementById('reg-address').value,
            address2: document.getElementById('reg-address2').value
        };

        fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'error') {
                alert("éŒ¯èª¤: " + data.msg);
            } else {
                // è‹¥åœ¨ LINE App å…§ï¼Œå˜—è©¦ç™¼é€è¨Šæ¯çµ¦å®˜æ–¹å¸³è™Ÿ
                if (liff.isInClient()) {
                    const msg = `ğŸ“ æœƒå“¡è³‡æ–™\nå§“åï¼š${payload.name}\né›»è©±ï¼š${payload.phone}\nç”Ÿæ—¥ï¼š${payload.birthDate}\nåœ°å€ï¼š${payload.address}\nå‚™ç”¨åœ°å€ï¼š${payload.address2 || 'ç„¡'}`;
                    liff.sendMessages([
                        {
                            type: 'text',
                            text: msg
                        }
                    ]).then(() => {
                        console.log("message sent");
                    }).catch((err) => {
                        console.log("error sending message", err);
                    });
                }

                // éš±è—åŸæœ¬çš„è¨»å†Šé ï¼Œé¡¯ç¤ºè¨»å†ŠæˆåŠŸé 
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('p-register-success').classList.add('active');
                
                // å¯ä»¥é¸æ“‡æ¸…ç©ºè¡¨å–®
                document.getElementById('form-register').reset();
            }
        });
    }

    function submitOrder() {
       var itemName = document.getElementById('order-items').value;
       var qty = document.getElementById('order-qty').value;
       var remarks = document.getElementById('order-remarks').value;
       var paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

       const payload = {
           userId: userId,
           itemName: itemName,
           qty: qty,
           remarks: remarks,
           paymentMethod: paymentMethod
       };

       fetch('/api/order', {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: JSON.stringify(payload)
       })
       .then(res => res.json())
       .then(data => {
            if(data.status === 'error') {
                alert("éŒ¯èª¤: " + data.msg);
            } else if (data.status === 'ecpay_init') {
                // Handle ECPay Redirection
                var form = document.createElement("form");
                form.setAttribute("method", "post");
                form.setAttribute("action", data.actionUrl);
                
                var params = data.ecpayParams;
                for (var key in params) {
                    if (params.hasOwnProperty(key)) {
                        var hiddenField = document.createElement("input");
                        hiddenField.setAttribute("type", "hidden");
                        hiddenField.setAttribute("name", key);
                        hiddenField.setAttribute("value", params[key]);
                        form.appendChild(hiddenField);
                    }
                }
                document.body.appendChild(form);
                form.submit();
            } else {
                // éš±è—åŸæœ¬çš„è¨‚è³¼é ï¼Œé¡¯ç¤ºæˆåŠŸé 
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('p-success').classList.add('active');
                
                // æ›´æ–°æˆåŠŸé é¢çš„è¨‚å–®ç·¨è™Ÿ
                document.getElementById('success-order-id').innerText = data.orderId;
                
                // æ¸…ç©ºåŸæœ¬çš„å‚™è¨»æ¬„ä½ (æ•¸é‡ä¿ç•™æˆ–é‡ç½®çœ‹éœ€æ±‚ï¼Œé€™è£¡é‡ç½®ç‚º1)
                document.getElementById('order-remarks').value = '';
                document.getElementById('order-qty').value = '1';
                calcPrice();
            }
       });
    }

    function loadHistory() {
        fetch('/api/history', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        })
        .then(res => res.json())
        .then(orders => {
            var html = "";
            if(!orders || orders.length === 0) html="<p class='text-center mt-3'>ç„¡è¨‚å–®è³‡æ–™</p>";
            else orders.forEach(o => {
                const payStatus = o.paymentStatus || 'æœªä»˜æ¬¾';
                html += `<div class="card mb-3 p-3">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">${o.date}</small>
                        <span class="badge ${getStatusBadge(o.status)}">${o.status}</span>
                    </div>
                    <h5 class="mt-2">${o.items}</h5>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div>
                            <span class="badge ${getPaymentBadgeClass(payStatus)}">${payStatus}</span>
                            <small class="text-muted ms-2">${formatPaymentMethod(o.paymentMethod)}</small>
                        </div>
                        <p class="text-end mb-0 price-tag">$${o.amount}</p>
                    </div>
                </div>`;
            });
            document.getElementById('history-list').innerHTML = html;
        });
    }

    function formatPaymentMethod(method) {
        switch(method) {
            case 'transfer': return 'éŠ€è¡Œè½‰å¸³/è²¨åˆ°ä»˜æ¬¾';
            case 'ecpay': return 'ç·šä¸Šæ”¯ä»˜ (ç¶ ç•Œ)';
            default: return method || 'æœªæŒ‡å®š';
        }
    }

    function getStatusBadge(status) {
        switch(status) {
            case 'è™•ç†ä¸­': return 'bg-warning text-dark';
            case 'å·²ç¢ºèª': return 'bg-info text-dark';
            case 'é…é€ä¸­': return 'bg-primary';
            case 'éƒ¨åˆ†é…é€': return 'bg-secondary text-dark';
            case 'å·²å®Œæˆ': return 'bg-success';
            case 'å·²å–æ¶ˆ': return 'bg-secondary';
            default: return 'bg-secondary';
        }
    }

    function getPaymentBadgeClass(status) {
        switch(status) {
            case 'å·²ä»˜æ¬¾': return 'bg-success';
            case 'é€€æ¬¾ä¸­': return 'bg-warning text-dark';
            case 'å·²é€€æ¬¾': return 'bg-dark';
            case 'æœªä»˜æ¬¾': return 'bg-danger';
            default: return 'bg-danger';
        }
    }
  </script>
</body>
</html>