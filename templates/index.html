<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åœŸé›è›‹è¨‚è³¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #fffbf0; }
    .page { display: none; }
    .active { display: block; }
    .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 12px; }
    .btn-main { background-color: #e67e22; color: white; border-radius: 8px; font-weight: bold; }
    .btn-main:hover { background-color: #d35400; color: white; }
    .price-tag { color: #c0392b; font-weight: bold; font-size: 1.2rem; }
  </style>
</head>
<body>

  <div id="loading" class="text-center mt-5">
    <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 text-muted">ç³»çµ±å•Ÿå‹•ä¸­...</h4>
  </div>

  <div id="p-register" class="page">
    <div class="card p-4">
      <h3 class="mb-4 text-center">ğŸ£ æ–°æœƒå“¡è¨»å†Š</h3>
      <form id="form-register">
        <div class="mb-3"><label>æ‚¨çš„å§“å</label><input type="text" class="form-control" id="reg-name" required></div>
        <div class="mb-3"><label>è¯çµ¡é›»è©±</label><input type="tel" class="form-control" id="reg-phone" inputmode="tel" required></div>
        <div class="mb-3"><label>é…é€åœ°å€</label><input type="text" class="form-control" id="reg-address" required></div>
        <div class="mb-3"><label>ç¬¬äºŒé…é€åœ°å€ (é¸å¡«)</label><input type="text" class="form-control" id="reg-address2"></div>
        <div class="mb-3"><label>ç”Ÿæ—¥ (é¸å¡«)</label><input type="date" class="form-control" id="reg-birthdate"></div>
        <button type="button" class="btn btn-main w-100 btn-lg py-3" onclick="submitRegister()">è¨»å†Šå¸³è™Ÿ</button>
      </form>
    </div>
  </div>

  <div id="p-welcome" class="page text-center">
    <div class="card p-5">
        <h3 class="mb-3">æ­¡è¿å›ä¾†ï¼</h3>
        <h2 class="text-primary mb-4" id="welcome-name">æœƒå“¡</h2>
        <p class="text-muted">æ‚¨å·²ç¶“æ˜¯æˆ‘å€‘çš„æœƒå“¡äº†ã€‚</p>
        <div class="d-grid gap-2">
            <button class="btn btn-main btn-lg" onclick="location.href='/?page=order'">æˆ‘è¦è¨‚è›‹</button>
            <button class="btn btn-outline-secondary" onclick="location.href='/?page=history'">æŸ¥çœ‹ç´€éŒ„</button>
            <button class="btn btn-outline-primary" onclick="location.href='/?page=edit'">æ›´æ–°æœƒå“¡è³‡æ–™</button>
        </div>
    </div>
  </div>

  <div id="p-edit-member" class="page">
    <div class="card p-4">
      <h3 class="mb-4 text-center">ğŸ£ æ›´æ–°æœƒå“¡è³‡æ–™</h3>
      <form id="form-edit-member">
        <div class="mb-3"><label>æ‚¨çš„å§“å</label><input type="text" class="form-control" id="edit-mem-name" required></div>
        <div class="mb-3"><label>è¯çµ¡é›»è©±</label><input type="tel" class="form-control" id="edit-mem-phone" inputmode="tel" required></div>
        <div class="mb-3"><label>é…é€åœ°å€</label><input type="text" class="form-control" id="edit-mem-address" required></div>
        <div class="mb-3"><label>ç¬¬äºŒé…é€åœ°å€ (é¸å¡«)</label><input type="text" class="form-control" id="edit-mem-address2"></div>
        <button type="button" class="btn btn-main w-100 btn-lg py-3" onclick="submitEditMember()">ä¿å­˜è®Šæ›´</button>
        <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="location.href='/?page=order'">è¿”å›</button>
      </form>
    </div>
  </div>

  <div id="p-order" class="page">
    <div class="card p-4">
      <h3 class="mb-4 text-center">ğŸ¥š æˆ‘è¦è¨‚è›‹</h3>
      <form id="form-order">
        <div class="mb-3">
          <label>é¸æ“‡å•†å“</label>
          <select class="form-select form-select-lg" id="order-items" onchange="calcPrice()">
            <option value="åœŸé›è›‹11ç›¤" data-price="2500">åœŸé›è›‹ 11ç›¤ ($2500)</option>
            <option value="åœŸé›è›‹1ç›¤" data-price="250">åœŸé›è›‹ 1ç›¤ ($250)</option>
          </select>
          <div id="price-tip" class="form-text text-danger mt-2" style="display:none;"></div>
        </div>
        <div class="mb-3">
          <label>æ•¸é‡</label>
          <div class="input-group input-group-lg">
            <button class="btn btn-outline-secondary" type="button" onclick="changeQty(-1)">-</button>
            <input type="number" class="form-control text-center" id="order-qty" value="1" min="1" readonly>
            <button class="btn btn-outline-secondary" type="button" onclick="changeQty(1)">+</button>
          </div>
        </div>
        <div class="mb-3">
          <label>å‚™è¨» (é¸å¡«)</label>
          <textarea class="form-control" id="order-remarks" rows="2" placeholder="ä¾‹å¦‚ï¼šè«‹ä¸‹åˆé…é€"></textarea>
        </div>

        <div class="mb-3">
            <label class="d-block mb-2">ä»˜æ¬¾æ–¹å¼</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="paymentMethod" id="pay-transfer" value="transfer" checked>
                <label class="form-check-label" for="pay-transfer">éŠ€è¡Œè½‰å¸³/è²¨åˆ°ä»˜æ¬¾</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="paymentMethod" id="pay-ecpay" value="ecpay">
                <label class="form-check-label" for="pay-ecpay">ç·šä¸Šæ”¯ä»˜ (ä¿¡ç”¨å¡/ATM)</label>
            </div>
        </div>

        <div class="alert alert-warning text-center">ç¸½é‡‘é¡: <span class="price-tag">$<span id="total-price">2500</span></span></div>
        <button type="button" class="btn btn-main w-100 btn-lg py-3" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
      </form>
    </div>
  </div>
  
  <div id="p-history" class="page">
    <h3 class="mb-3">ğŸ“œ è¨‚è³¼ç´€éŒ„</h3>
    <div id="history-list" class="list-group">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="p-success" class="page text-center">
    <div class="card p-5">
      <div class="mb-3" style="font-size: 4rem;">âœ…</div>
      <h3 class="mb-3">è¨‚å–®å·²æ”¶åˆ°ï¼</h3>
      <p class="text-muted">æ‚¨çš„è¨‚å–®ç·¨è™Ÿç‚ºï¼š</p>
      <h2 class="text-primary mb-4" id="success-order-id">ORD...</h2>
      <p>æˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨å®‰æ’é…é€ã€‚</p>
      <div class="d-grid gap-2">
        <button class="btn btn-outline-primary" onclick="location.href='/?page=history'">æŸ¥çœ‹è¨‚è³¼ç´€éŒ„</button>
        <button class="btn btn-outline-secondary" onclick="if(liff.isInClient()){liff.closeWindow();}else{location.href='/?page=order';}">é—œé–‰ / ç¹¼çºŒè¨‚è³¼</button>
      </div>
    </div>
  </div>

  <div id="p-register-success" class="page text-center">
    <div class="card p-5">
      <div class="mb-3" style="font-size: 4rem;">ğŸ‰</div>
      <h3 class="mb-3">è¨»å†ŠæˆåŠŸï¼</h3>
      <p class="text-muted">æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹è¨‚è³¼å•†å“äº†ã€‚</p>
      <div class="d-grid gap-2">
        <button class="btn btn-main" onclick="location.href='/?page=order'">å‰å¾€è¨‚è³¼é </button>
        <button class="btn btn-outline-secondary" onclick="if(liff.isInClient()){liff.closeWindow();}else{location.href='/?page=register';}">é—œé–‰ / è¿”å›è¨»å†Šé </button>
      </div>
    </div>
  </div>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    /**
     * LINE LIFF SDK åˆå§‹åŒ–èªªæ˜
     * 
     * LIFF (LINE Front-end Framework) æ˜¯ LINE æä¾›çš„å‰ç«¯æ¡†æ¶ï¼Œè®“ Web App åœ¨ LINE æ‡‰ç”¨å…§é‹è¡Œ
     * ä¸¦å–å¾—ä½¿ç”¨è€…ä¿¡æ¯ã€ç™¼é€è¨Šæ¯ç­‰åŠŸèƒ½ã€‚
     * 
     * æ­¥é©Ÿï¼š
     * 1. åœ¨ LINE Developers å»ºç«‹ LIFF App ä¸¦å–å¾— LIFF ID
     * 2. åœ¨ä¸‹é¢çš„ MY_LIFF_ID å¡«å…¥ä½ çš„ LIFF ID
     * 3. éƒ¨ç½²æ‡‰ç”¨ä¸¦åœ¨ LIFF è¨­å®šä¸­é…ç½® URL
     * 
     * LINE å®˜æ–¹æ–‡æª”ï¼šhttps://developers.line.biz/en/docs/liff/
     */
    
    var MY_LIFF_ID = "2008795367-LqjjCaaQ";  // æ›¿æ›ç‚ºä½ çš„ LIFF ID
    var userId = null;
    var userName = "";

    // å•Ÿå‹•é‚è¼¯
    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
             // é–‹ç™¼æ¨¡å¼ï¼šåœ¨é›»è…¦ç€è¦½å™¨ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ
             if(!liff.isInClient()) {
                console.log("ğŸ–¥ï¸ é–‹ç™¼æ¨¡å¼: ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ");
                userId = "TEST_USER_001";
                checkMemberStatus();
             } else {
                // åœ¨ LINE App å…§éœ€è¦ç™»å…¥
                liff.login(); 
             }
          } else {
            liff.getProfile().then(profile => {
              userId = profile.userId;
              userName = profile.displayName;
              checkMemberStatus();
            }).catch(err => {
                console.error("âŒ å–å¾—ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:", err);
                document.getElementById('loading').innerHTML += '<p class="text-danger">ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™: ' + err + '</p>';
            });
          }
        })
        .catch(err => {
            console.log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—:", err);
            document.getElementById('loading').innerHTML += '<p class="text-danger">LIFF åˆå§‹åŒ–å¤±æ•—: ' + err + '</p>';
            // Fallbackï¼šåœ¨é–‹ç™¼ç’°å¢ƒä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ
            if(!liff.isInClient()) {
                userId = "TEST_USER_001";
                checkMemberStatus();
            }
        });
    };

    function checkMemberStatus() {
        if (!userId) return;

        // å¦‚æœç¶²å€æœ‰æŒ‡å®š pageï¼Œå°±ç›´æ¥å»è©²é é¢ï¼Œä¸æª¢æŸ¥æœƒå“¡ (ä¾‹å¦‚æƒ³ç›´æ¥çœ‹æ­·å²ç´€éŒ„)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('page')) {
            document.getElementById('loading').style.display = 'none';
            resolveRoute();
            return;
        }

        // å‘¼å«å¾Œç«¯æª¢æŸ¥æœƒå“¡ç‹€æ…‹
        fetch('/api/check_member', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            if (data.registered) {
                // å·²è¨»å†Š -> é¡¯ç¤ºæ­¡è¿é é¢
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('p-welcome').classList.add('active');
                document.getElementById('welcome-name').innerText = data.name;
            } else {
                // æœªè¨»å†Š -> é¡¯ç¤ºè¨»å†Šé é¢ (é è¨­è¡Œç‚º)
                resolveRoute();
            }
        })
        .catch(err => {
            console.error("Check member error:", err);
            document.getElementById('loading').style.display = 'none';
            resolveRoute();
        });
    }

    function resolveRoute() {
      const urlParams = new URLSearchParams(window.location.search);
      const page = urlParams.get('page') || 'register';
      
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
      
      if (page === 'register') {
        document.getElementById('p-register').classList.add('active');
      } else if (page === 'welcome') {
        document.getElementById('p-welcome').classList.add('active');
      } else if (page === 'edit') {
        // å…ˆè¼‰å…¥æœƒå“¡è³‡æ–™ï¼Œå†é¡¯ç¤ºé é¢
        loadMemberDataForEdit().then(() => {
          document.getElementById('p-edit-member').classList.add('active');
        });
      } else if (page === 'order') {
        document.getElementById('p-order').classList.add('active');
      } else if (page === 'history') {
        document.getElementById('p-history').classList.add('active');
        loadHistory();
      }
    }

    // è¨ˆç®—åƒ¹æ ¼
    function changeQty(delta) {
      var input = document.getElementById('order-qty');
      var val = parseInt(input.value) + delta;
      if (val < 1) val = 1;
      input.value = val;
      calcPrice();
    }
    function calcPrice() {
      var selectedOption = document.getElementById('order-items').selectedOptions[0];
      var itemName = selectedOption.value;
      var qty = parseInt(document.getElementById('order-qty').value);
      var price = 0;
      var tipDiv = document.getElementById('price-tip');

      if (itemName === "åœŸé›è›‹1ç›¤") {
          // é¡¯ç¤ºå„ªæƒ æç¤º
          tipDiv.style.display = 'block';
          tipDiv.innerHTML = "ğŸ’¡ å„ªæƒ æç¤ºï¼šè²·10ç›¤ä»¥ä¸Šæ¯ç›¤$240ï¼Œ20ç›¤ä»¥ä¸Šæ¯ç›¤$230ï¼";

          // ç‰¹æ®Šè¨ˆåƒ¹: 1-9ç›¤ 250, 10-19ç›¤ 240, 20ç›¤ä»¥ä¸Š 230
          if (qty >= 20) {
              price = 230;
          } else if (qty >= 10) {
              price = 240;
          } else {
              price = 250;
          }
      } else {
          // éš±è—å„ªæƒ æç¤º
          tipDiv.style.display = 'none';
          
          // å…¶ä»–å•†å“ä¾ç…§ data-price
          price = parseInt(selectedOption.dataset.price);
      }
      
      document.getElementById('total-price').innerText = price * qty;
    }

    // === æ–°ç‰ˆï¼šä½¿ç”¨ fetch å‘¼å« Python API ===

    function submitRegister() {
        // è¡¨å–®é©—è­‰
        const name = document.getElementById('reg-name').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const address = document.getElementById('reg-address').value.trim();
        const birthdate = document.getElementById('reg-birthdate').value.trim();
        const address2 = document.getElementById('reg-address2').value.trim();
        
        // é©—è­‰é‚è¼¯
        if (!name) {
            alert("âŒ å§“åä¸èƒ½ç‚ºç©º");
            return;
        }
        if (name.length > 50) {
            alert("âŒ å§“åé•·åº¦ä¸èƒ½è¶…é 50 å€‹å­—å…ƒ");
            return;
        }
        
        if (!phone) {
            alert("âŒ è¯çµ¡é›»è©±ä¸èƒ½ç‚ºç©º");
            return;
        }
        const phonePattern = /^\d{10}$|^09\d{8}$/;
        if (!phonePattern.test(phone.replace('-', ''))) {
            alert("âŒ é›»è©±æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥ 10 ä½æ•¸å­— (ä¾‹ï¼š0912345678)");
            return;
        }
        
        if (!address) {
            alert("âŒ é…é€åœ°å€ä¸èƒ½ç‚ºç©º");
            return;
        }
        if (address.length > 200) {
            alert("âŒ åœ°å€é•·åº¦ä¸èƒ½è¶…é 200 å€‹å­—å…ƒ");
            return;
        }
        
        if (birthdate && !/^\d{4}-\d{2}-\d{2}$/.test(birthdate)) {
            alert("âŒ å‡ºç”Ÿæ—¥æœŸæ ¼å¼ä¸æ­£ç¢º (æ ¼å¼ï¼šYYYY-MM-DD)");
            return;
        }
        
        if (address2 && address2.length > 200) {
            alert("âŒ ç¬¬äºŒåœ°å€é•·åº¦ä¸èƒ½è¶…é 200 å€‹å­—å…ƒ");
            return;
        }
        
        const payload = {
            userId: userId,
            name: name,
            birthDate: birthdate,
            phone: phone,
            address: address,
            address2: address2
        };

        fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'error') {
                const errorMsg = data.errors ? data.errors.join('\n') : data.msg;
                alert("âŒ è¨»å†Šå¤±æ•—:\n" + errorMsg);
            } else {
                // è‹¥åœ¨ LINE App å…§ï¼Œå˜—è©¦ç™¼é€è¨Šæ¯çµ¦å®˜æ–¹å¸³è™Ÿ
                if (liff.isInClient()) {
                    const msg = `ğŸ“ æœƒå“¡è³‡æ–™\nå§“åï¼š${payload.name}\né›»è©±ï¼š${payload.phone}\nç”Ÿæ—¥ï¼š${payload.birthDate || 'æœªæä¾›'}\nåœ°å€ï¼š${payload.address}\nå‚™ç”¨åœ°å€ï¼š${payload.address2 || 'ç„¡'}`;
                    liff.sendMessages([
                        {
                            type: 'text',
                            text: msg
                        }
                    ]).then(() => {
                        console.log("âœ… è¨Šæ¯å·²ç™¼é€");
                    }).catch((err) => {
                        console.log("âš ï¸ ç„¡æ³•ç™¼é€è¨Šæ¯", err);
                    });
                }

                // éš±è—åŸæœ¬çš„è¨»å†Šé ï¼Œé¡¯ç¤ºè¨»å†ŠæˆåŠŸé 
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('p-register-success').classList.add('active');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('form-register').reset();
            }
        })
        .catch(err => {
            console.error("Registration error:", err);
            alert("âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦");
        });
    }

    function loadMemberDataForEdit() {
        // å¾å¾Œç«¯è¼‰å…¥æœƒå“¡è³‡æ–™å¡«å…¥ç·¨è¼¯è¡¨å–®
        return fetch('/api/check_member', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        })
        .then(res => res.json())
        .then(data => {
            if (data.registered && data.data) {
                document.getElementById('edit-mem-name').value = data.data.name || '';
                document.getElementById('edit-mem-phone').value = data.data.phone || '';
                document.getElementById('edit-mem-address').value = data.data.address || '';
                document.getElementById('edit-mem-address2').value = data.data.address2 || '';
            }
            return data;
        })
        .catch(err => {
            console.error("Load member error:", err);
            alert("âŒ è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—");
            return null;
        });
    }

    function submitEditMember() {
        // è¡¨å–®é©—è­‰
        const name = document.getElementById('edit-mem-name').value.trim();
        const phone = document.getElementById('edit-mem-phone').value.trim();
        const address = document.getElementById('edit-mem-address').value.trim();
        const address2 = document.getElementById('edit-mem-address2').value.trim();
        
        if (!name) {
            alert("âŒ å§“åä¸èƒ½ç‚ºç©º");
            return;
        }
        if (name.length > 50) {
            alert("âŒ å§“åé•·åº¦ä¸èƒ½è¶…é 50 å€‹å­—å…ƒ");
            return;
        }
        
        if (!phone) {
            alert("âŒ è¯çµ¡é›»è©±ä¸èƒ½ç‚ºç©º");
            return;
        }
        const phonePattern = /^\d{10}$|^09\d{8}$/;
        if (!phonePattern.test(phone.replace('-', ''))) {
            alert("âŒ é›»è©±æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹è¼¸å…¥ 10 ä½æ•¸å­— (ä¾‹ï¼š0912345678)");
            return;
        }
        
        if (!address) {
            alert("âŒ é…é€åœ°å€ä¸èƒ½ç‚ºç©º");
            return;
        }
        if (address.length > 200) {
            alert("âŒ åœ°å€é•·åº¦ä¸èƒ½è¶…é 200 å€‹å­—å…ƒ");
            return;
        }
        
        if (address2 && address2.length > 200) {
            alert("âŒ ç¬¬äºŒåœ°å€é•·åº¦ä¸èƒ½è¶…é 200 å€‹å­—å…ƒ");
            return;
        }
        
        if (!confirm("ç¢ºèªè¦ä¿å­˜æœƒå“¡è³‡æ–™å—ï¼Ÿ")) return;

        fetch('/api/edit_member', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                userId: userId,
                name: name,
                phone: phone,
                address: address,
                address2: address2
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert("âœ… æœƒå“¡è³‡æ–™å·²æ›´æ–°");
                document.getElementById('welcome-name').innerText = name;
                location.href = '/?page=welcome';
            } else {
                alert("âŒ æ›´æ–°å¤±æ•—: " + data.msg);
            }
        })
        .catch(err => {
            console.error("Edit member error:", err);
            alert("âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦");
        });
    }

    function submitOrder() {
       const itemName = document.getElementById('order-items').value;
       const qty = parseInt(document.getElementById('order-qty').value);
       const remarks = document.getElementById('order-remarks').value.trim();
       const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

       // é©—è­‰é‚è¼¯
       if (!itemName) {
           alert("âŒ è«‹é¸æ“‡å•†å“");
           return;
       }
       
       if (!qty || qty < 1 || qty > 1000) {
           alert("âŒ æ•¸é‡å¿…é ˆåœ¨ 1-1000 ä¹‹é–“");
           return;
       }
       
       if (remarks && remarks.length > 500) {
           alert("âŒ å‚™è¨»é•·åº¦ä¸èƒ½è¶…é 500 å€‹å­—å…ƒ");
           return;
       }

       const payload = {
           userId: userId,
           itemName: itemName,
           qty: qty,
           remarks: remarks,
           paymentMethod: paymentMethod
       };

       fetch('/api/order', {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: JSON.stringify(payload)
       })
       .then(res => res.json())
       .then(data => {
            if(data.status === 'error') {
                const errorMsg = data.errors ? data.errors.join('\n') : data.msg;
                alert("âŒ è¨‚è³¼å¤±æ•—:\n" + errorMsg);
            } else if (data.status === 'ecpay_init') {
                // ECPay ä»˜æ¬¾æµç¨‹
                var form = document.createElement("form");
                form.setAttribute("method", "post");
                form.setAttribute("action", data.actionUrl);
                
                var params = data.ecpayParams;
                for (var key in params) {
                    if (params.hasOwnProperty(key)) {
                        var hiddenField = document.createElement("input");
                        hiddenField.setAttribute("type", "hidden");
                        hiddenField.setAttribute("name", key);
                        hiddenField.setAttribute("value", params[key]);
                        form.appendChild(hiddenField);
                    }
                }
                document.body.appendChild(form);
                form.submit();
            } else {
                // è¨‚è³¼æˆåŠŸ - é¡¯ç¤ºæˆåŠŸé 
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('p-success').classList.add('active');
                document.getElementById('success-order-id').innerText = data.orderId;
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('order-remarks').value = '';
                document.getElementById('order-qty').value = '1';
                calcPrice();
            }
       })
       .catch(err => {
           console.error("Order error:", err);
           alert("âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦");
       });
    }

    function loadHistory() {
        fetch('/api/history', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: userId})
        })
        .then(res => res.json())
        .then(orders => {
            var html = "";
            if(!orders || orders.length === 0) html="<p class='text-center mt-3'>ç„¡è¨‚å–®è³‡æ–™</p>";
            else orders.forEach(o => {
                const payStatus = o.paymentStatus || 'æœªä»˜æ¬¾';
                // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œé‡æ–°ä»˜æ¬¾ã€æŒ‰éˆ•ï¼šæœªä»˜æ¬¾ + ç¶ ç•Œæ”¯ä»˜
                const showRetryBtn = (payStatus === 'æœªä»˜æ¬¾' || payStatus === 'å¾…ä»˜æ¬¾') && o.paymentMethod === 'ecpay';
                
                html += `<div class="card mb-3 p-3">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">${o.date}</small>
                        <span class="badge ${getStatusBadge(o.status)}">${o.status}</span>
                    </div>
                    <h5 class="mt-2">${o.items}</h5>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div>
                            <span class="badge ${getPaymentBadgeClass(payStatus)}">${payStatus}</span>
                            <small class="text-muted ms-2">${formatPaymentMethod(o.paymentMethod)}</small>
                        </div>
                        <p class="text-end mb-0 price-tag">$${o.amount}</p>
                    </div>
                    ${showRetryBtn ? `<button class="btn btn-sm btn-warning mt-2" onclick="retryPayment('${o.orderId}')">ğŸ”„ é‡æ–°ä»˜æ¬¾</button>` : ''}
                </div>`;
            });
            document.getElementById('history-list').innerHTML = html;
        });
    }

    function formatPaymentMethod(method) {
        switch(method) {
            case 'transfer': return 'éŠ€è¡Œè½‰å¸³/è²¨åˆ°ä»˜æ¬¾';
            case 'ecpay': return 'ç·šä¸Šæ”¯ä»˜ (ç¶ ç•Œ)';
            default: return method || 'æœªæŒ‡å®š';
        }
    }

    function getStatusBadge(status) {
        switch(status) {
            case 'è™•ç†ä¸­': return 'bg-warning text-dark';
            case 'å·²ç¢ºèª': return 'bg-info text-dark';
            case 'é…é€ä¸­': return 'bg-primary';
            case 'éƒ¨åˆ†é…é€': return 'bg-secondary text-dark';
            case 'å·²å®Œæˆ': return 'bg-success';
            case 'å·²å–æ¶ˆ': return 'bg-secondary';
            default: return 'bg-secondary';
        }
    }

    function getPaymentBadgeClass(status) {
        switch(status) {
            case 'å·²ä»˜æ¬¾': return 'bg-success';
            case 'é€€æ¬¾ä¸­': return 'bg-warning text-dark';
            case 'å·²é€€æ¬¾': return 'bg-dark';
            case 'å¾…ä»˜æ¬¾': return 'bg-warning text-dark';
            case 'æœªä»˜æ¬¾': return 'bg-danger';
            default: return 'bg-danger';
        }
    }

    function retryPayment(orderId) {
        if (!confirm("ç¢ºèªè¦é‡æ–°é€²è¡Œç·šä¸Šä»˜æ¬¾ï¼Ÿ")) return;
        
        // è¨ˆç®—é‡è©¦æ¬¡æ•¸ï¼šæ ¹æ“šå‰é¢çš„é‡è©¦æŒ‰éˆ•é»æ“Šæ¬¡æ•¸
        // ç°¡å–®æ–¹æ¡ˆï¼šç™¼é€æ™‚é è¨­ç‚º 1ï¼Œæœå‹™ç«¯å¯æ ¹æ“šç¶ ç•Œè¿”å›çš„éŒ¯èª¤å‹•æ…‹éå¢
        let retryCount = 1;
        
        fetch('/api/retry_payment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({orderId: orderId, retryCount: retryCount})
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ecpay_init') {
                // æäº¤ ECPay è¡¨å–®
                var form = document.createElement("form");
                form.setAttribute("method", "post");
                form.setAttribute("action", data.actionUrl);
                
                var params = data.ecpayParams;
                for (var key in params) {
                    if (params.hasOwnProperty(key)) {
                        var hiddenField = document.createElement("input");
                        hiddenField.setAttribute("type", "hidden");
                        hiddenField.setAttribute("name", key);
                        hiddenField.setAttribute("value", params[key]);
                        form.appendChild(hiddenField);
                    }
                }
                document.body.appendChild(form);
                form.submit();
            } else {
                alert("âŒ é‡æ–°ä»˜æ¬¾å¤±æ•—: " + data.msg);
            }
        })
        .catch(err => {
            console.error("Retry payment error:", err);
            alert("âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦");
        });
    }
  </script>
</body>
</html>