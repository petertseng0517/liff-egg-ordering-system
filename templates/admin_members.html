<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡ç®¡ç† - è›‹å•†å“ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        * {
            font-family: "Microsoft YaHei", Segoe UI, Roboto, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        .navbar {
            background-color: #2c3e50 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .nav-link.active {
            border-bottom: 3px solid #3498db !important;
        }
        
        .container-main {
            margin-top: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .table {
            background-color: white;
            border-radius: 4px;
        }
        
        .table thead {
            background-color: #ecf0f1;
        }
        
        .table th {
            color: #2c3e50;
            font-weight: 600;
            border: none;
            padding: 15px;
        }
        
        .table td {
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .status-å•Ÿç”¨ {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-åœç”¨ {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-é»‘åå–® {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .btn-action {
            padding: 5px 10px;
            font-size: 0.9em;
            margin: 2px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .pagination {
            margin-top: 20px;
        }
        
        .stats-box {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .stats-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<!-- å°èˆªæ¬„ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">ğŸ¥š åœŸé›è›‹ç®¡ç†å¾Œå°</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="/admin">ğŸ“‹ è¨‚å–®ç®¡ç†</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/products">ğŸ“¦ å•†å“ç®¡ç†</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/reports">ğŸ“Š å ±è¡¨ç®¡ç†</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/admin/members">ğŸ‘¥ æœƒå“¡ç®¡ç†</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/settings">âš™ï¸ ç³»çµ±è¨­å®š</a>
        </li>
      </ul>
    </div>
    <a href="/logout" class="btn btn-outline-light btn-sm">ç™»å‡º</a>
  </div>
</nav>

<!-- ä¸»å®¹å™¨ -->
<div class="container-fluid container-main">
    <!-- çµ±è¨ˆå€åŸŸ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-box">
                <div class="stats-number" id="total-members">0</div>
                <div class="stats-label">ç¸½æœƒå“¡æ•¸</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box">
                <div class="stats-number" id="active-members">0</div>
                <div class="stats-label">å•Ÿç”¨æœƒå“¡</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box">
                <div class="stats-number" id="disabled-members">0</div>
                <div class="stats-label">åœç”¨æœƒå“¡</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box">
                <div class="stats-number" id="blacklist-members">0</div>
                <div class="stats-label">é»‘åå–®æœƒå“¡</div>
            </div>
        </div>
    </div>

    <!-- ç¯©é¸å’Œæ“ä½œå€ -->
    <div class="filter-section">
        <div class="row align-items-end">
            <div class="col-md-5">
                <label class="form-label">æœå°‹</label>
                <input type="text" class="form-control" id="search-input" 
                       placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿæˆ–æœƒå“¡ID">
            </div>
            <div class="col-md-3">
                <label class="form-label">ç¯©é¸ç‹€æ…‹</label>
                <select class="form-select" id="status-filter">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="å•Ÿç”¨">âœ… å•Ÿç”¨</option>
                    <option value="åœç”¨">â¸ï¸ åœç”¨</option>
                    <option value="é»‘åå–®">ğŸš« é»‘åå–®</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" onclick="loadMembers()">
                    <i class="bi bi-arrow-clockwise"></i> é‡æ–°æ•´ç†
                </button>
                <button class="btn btn-success" onclick="exportMembers()">
                    <i class="bi bi-download"></i> å°å‡º CSV
                </button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">
            æœƒå“¡åˆ—è¡¨
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="members-table">
                    <thead>
                        <tr>
                            <th>æœƒå“¡ID</th>
                            <th>å§“å</th>
                            <th>æ‰‹æ©Ÿ</th>
                            <th>åœ°å€</th>
                            <th>ç‹€æ…‹</th>
                            <th>åŠ å…¥æ—¥æœŸ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="members-tbody">
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åˆ†é  -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
        </ul>
    </nav>
</div>

<!-- ç·¨è¼¯æœƒå“¡æ¨¡æ…‹çª— -->
<div class="modal fade" id="editMemberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç·¨è¼¯æœƒå“¡è³‡æ–™</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="edit-member-form">
            <input type="hidden" id="edit-user-id">
            
            <div class="mb-3">
                <label class="form-label">æœƒå“¡ID</label>
                <input type="text" class="form-control" id="edit-user-id-display" disabled>
            </div>
            
            <div class="mb-3">
                <label class="form-label">å§“å <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="edit-name" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">æ‰‹æ©Ÿ <span class="text-danger">*</span></label>
                <input type="tel" class="form-control" id="edit-phone" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">åœ°å€ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="edit-address" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">åœ°å€å‚™è¨»</label>
                <input type="text" class="form-control" id="edit-address2">
            </div>
            
            <div class="mb-3">
                <label class="form-label">ç”Ÿæ—¥</label>
                <input type="date" class="form-control" id="edit-birth-date">
            </div>
            
            <div class="mb-3">
                <label class="form-label">æœƒå“¡ç‹€æ…‹ <span class="text-danger">*</span></label>
                <select class="form-select" id="edit-status" required>
                    <option value="å•Ÿç”¨">âœ… å•Ÿç”¨</option>
                    <option value="åœç”¨">â¸ï¸ åœç”¨</option>
                    <option value="é»‘åå–®">ğŸš« é»‘åå–®</option>
                </select>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveMemberChanges()">ä¿å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>
</div>

<!-- ç¢ºèªè®Šæ›´æ¨¡æ…‹çª— -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¢ºèªæ“ä½œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="confirm-message"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-danger" id="confirm-btn" onclick="confirmAction()">ç¢ºèª</button>
      </div>
    </div>
  </div>
</div>

<!-- ID é©—è­‰å·¥å…·æ¨¡æ…‹çª— -->
<div class="modal fade" id="verificationModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">âš ï¸ æœƒå“¡ ID é©—è­‰å·¥å…·</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          <strong>â“ ç‚ºä»€éº¼éœ€è¦é©—è­‰ï¼Ÿ</strong><br>
          è©²æœƒå“¡çš„ LINE ID æ ¼å¼ä¸å®Œæ•´ã€‚éœ€è¦é‡æ–°é©—è­‰ä»¥ç²å¾—å®Œæ•´çš„ 32 ä½ IDã€‚
        </div>

        <div class="mb-4">
          <h6>ğŸ“‹ æœƒå“¡ä¿¡æ¯</h6>
          <table class="table table-sm">
            <tr>
              <td><strong>æœƒå“¡IDï¼š</strong></td>
              <td id="verify-user-id-display"></td>
            </tr>
            <tr>
              <td><strong>å§“åï¼š</strong></td>
              <td id="verify-member-name"></td>
            </tr>
            <tr>
              <td><strong>æ‰‹æ©Ÿï¼š</strong></td>
              <td id="verify-member-phone"></td>
            </tr>
          </table>
        </div>

        <div class="mb-4">
          <h6>ğŸ”— é©—è­‰æ–¹å¼</h6>
          <div class="nav nav-tabs" role="tablist">
            <button class="nav-link active" id="method1-tab" data-bs-toggle="tab" data-bs-target="#method1" type="button" role="tab">
              ç”Ÿæˆé©—è­‰é€£çµ
            </button>
            <button class="nav-link" id="method2-tab" data-bs-toggle="tab" data-bs-target="#method2" type="button" role="tab">
              æ‰‹å‹•è¼¸å…¥ ID
            </button>
            <button class="nav-link" id="method3-tab" data-bs-toggle="tab" data-bs-target="#method3" type="button" role="tab">
              æŸ¥çœ‹æ—¥èªŒ
            </button>
          </div>

          <!-- æ–¹æ³• 1ï¼šç”Ÿæˆé©—è­‰é€£çµ -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="method1" role="tabpanel">
              <div class="mt-3">
                <p>è¤‡è£½ä»¥ä¸‹é€£çµç™¼é€çµ¦æœƒå“¡ï¼Œä»–å€‘é»æ“Šå¾Œæœƒè‡ªå‹•é©—è­‰ä¸¦æ›´æ–° IDï¼š</p>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="verification-link" readonly>
                  <button class="btn btn-outline-secondary" onclick="copyToClipboard('verification-link')" type="button">
                    <i class="bi bi-clipboard"></i> è¤‡è£½
                  </button>
                </div>
                <small class="text-muted">é€£çµæœ‰æ•ˆæœŸï¼š24 å°æ™‚</small>
              </div>
            </div>

            <!-- æ–¹æ³• 2ï¼šæ‰‹å‹•è¼¸å…¥ ID -->
            <div class="tab-pane fade" id="method2" role="tabpanel">
              <div class="mt-3">
                <label class="form-label">å®Œæ•´çš„ LINE User ID</label>
                <input type="text" class="form-control" id="manual-user-id" placeholder="ä¾‹ï¼šU3fc41859edbcbbdae05141bf30b2e14c">
                <small class="form-text text-muted">æ ¼å¼ï¼šU + 32 å€‹åå…­é€²åˆ¶å­—ç¬¦</small>
                <button class="btn btn-primary mt-3" onclick="manuallyUpdateUserId()">æ›´æ–°</button>
              </div>
            </div>

            <!-- æ–¹æ³• 3ï¼šæŸ¥çœ‹æ—¥èªŒ -->
            <div class="tab-pane fade" id="method3" role="tabpanel">
              <div class="mt-3">
                <p>æœ€è¿‘çš„ Webhook æ—¥èªŒï¼š</p>
                <div id="webhook-logs" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85em;">
                  <p class="text-muted">è¼‰å…¥ä¸­...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allMembers = [];
let currentPage = 1;
const itemsPerPage = 10;
let pendingAction = {};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadMembers();
    
    // æœå°‹å’Œç¯©é¸äº‹ä»¶ç›£è½
    document.getElementById('search-input').addEventListener('keyup', applyFilters);
    document.getElementById('status-filter').addEventListener('change', applyFilters);
});

// è¼‰å…¥æœƒå“¡åˆ—è¡¨
function loadMembers() {
    fetch('/api/admin/members')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                allMembers = data.members || [];
                updateStatistics();
                applyFilters();
            } else {
                alert('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—: ' + data.msg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('è½½å…¥ä¼šå‘˜åˆ—è¡¨å‡ºé”™');
        });
}

// æ›´æ–°çµ±è¨ˆæ•¸æ“š
function updateStatistics() {
    const total = allMembers.length;
    const active = allMembers.filter(m => m.status === 'å•Ÿç”¨').length;
    const disabled = allMembers.filter(m => m.status === 'åœç”¨').length;
    const blacklist = allMembers.filter(m => m.status === 'é»‘åå–®').length;
    
    document.getElementById('total-members').textContent = total;
    document.getElementById('active-members').textContent = active;
    document.getElementById('disabled-members').textContent = disabled;
    document.getElementById('blacklist-members').textContent = blacklist;
}

// æ‡‰ç”¨ç¯©é¸å’Œæœå°‹
function applyFilters() {
    const searchText = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    
    let filtered = allMembers.filter(member => {
        const matchSearch = !searchText || 
                          member.userId.toLowerCase().includes(searchText) ||
                          member.name.toLowerCase().includes(searchText) ||
                          member.phone.includes(searchText);
        
        const matchStatus = !statusFilter || member.status === statusFilter;
        
        return matchSearch && matchStatus;
    });
    
    currentPage = 1;
    displayMembers(filtered);
}

// é¡¯ç¤ºæœƒå“¡åˆ—è¡¨
function displayMembers(members) {
    const tbody = document.getElementById('members-tbody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageMembers = members.slice(startIndex, endIndex);
    
    if (pageMembers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æœƒå“¡</td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }
    
    tbody.innerHTML = pageMembers.map(member => {
        const isValidId = isValidLineUserId(member.userId);
        const idWarning = !isValidId ? ' <span class="badge bg-danger ms-2" title="ç„¡æ•ˆçš„ LINE ID">âš ï¸ éœ€é©—è­‰</span>' : '';
        
        return `
        <tr ${!isValidId ? 'style="background-color: #fffbf0;"' : ''}>
            <td><small>${member.userId}${idWarning}</small></td>
            <td>${member.name}</td>
            <td>${member.phone}</td>
            <td><small>${member.address}${member.address2 ? ' ' + member.address2 : ''}</small></td>
            <td>
                <span class="status-badge status-${member.status}">
                    ${getStatusIcon(member.status)} ${member.status}
                </span>
            </td>
            <td><small>${formatDate(member.createdAt)}</small></td>
            <td>
                <button class="btn btn-sm btn-primary btn-action" onclick="editMember('${member.userId}')">
                    <i class="bi bi-pencil"></i> ç·¨è¼¯
                </button>
                ${!isValidId ? `
                <button class="btn btn-sm btn-warning btn-action" onclick="generateVerificationToken('${member.userId}')">
                    <i class="bi bi-exclamation-triangle"></i> é©—è­‰
                </button>
                ` : ''}
                <div class="btn-group btn-action" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-gear"></i> ç‹€æ…‹
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" onclick="changeStatus('${member.userId}', 'å•Ÿç”¨')">âœ… å•Ÿç”¨</a></li>
                        <li><a class="dropdown-item" onclick="changeStatus('${member.userId}', 'åœç”¨')">â¸ï¸ åœç”¨</a></li>
                        <li><a class="dropdown-item" onclick="changeStatus('${member.userId}', 'é»‘åå–®')">ğŸš« é»‘åå–®</a></li>
                    </ul>
                </div>
            </td>
        </tr>
    `}).join('');
    
    // åˆ†é æŒ‰éˆ•
    const totalPages = Math.ceil(members.length / itemsPerPage);
    displayPagination(totalPages, members);
}

// é¡¯ç¤ºåˆ†é æŒ‰éˆ•
function displayPagination(totalPages, members) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // ä¸Šä¸€é 
    const prevBtn = document.createElement('li');
    prevBtn.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
    prevBtn.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">ä¸Šä¸€é </a>`;
    pagination.appendChild(prevBtn);
    
    // é ç¢¼æŒ‰éˆ•
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('li');
        btn.className = 'page-item' + (i === currentPage ? ' active' : '');
        btn.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
        pagination.appendChild(btn);
    }
    
    // ä¸‹ä¸€é 
    const nextBtn = document.createElement('li');
    nextBtn.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
    nextBtn.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">ä¸‹ä¸€é </a>`;
    pagination.appendChild(nextBtn);
}

// è·³åˆ°æŒ‡å®šé 
function goToPage(page) {
    currentPage = page;
    applyFilters();
}

// ç·¨è¼¯æœƒå“¡
function editMember(userId) {
    const member = allMembers.find(m => m.userId === userId);
    if (!member) return;
    
    document.getElementById('edit-user-id').value = userId;
    document.getElementById('edit-user-id-display').value = userId;
    document.getElementById('edit-name').value = member.name;
    document.getElementById('edit-phone').value = member.phone;
    document.getElementById('edit-address').value = member.address;
    document.getElementById('edit-address2').value = member.address2 || '';
    document.getElementById('edit-birth-date').value = member.birthDate || '';
    document.getElementById('edit-status').value = member.status || 'å•Ÿç”¨';
    
    new bootstrap.Modal(document.getElementById('editMemberModal')).show();
}

// ä¿å­˜æœƒå“¡è®Šæ›´
function saveMemberChanges() {
    const userId = document.getElementById('edit-user-id').value;
    const name = document.getElementById('edit-name').value.trim();
    const phone = document.getElementById('edit-phone').value.trim();
    const address = document.getElementById('edit-address').value.trim();
    const address2 = document.getElementById('edit-address2').value.trim();
    const status = document.getElementById('edit-status').value;
    
    if (!name || !phone || !address) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼ˆå§“åã€æ‰‹æ©Ÿã€åœ°å€ï¼‰');
        return;
    }
    
    // å…ˆæ›´æ–°åŸºæœ¬è³‡æ–™
    fetch('/api/member/edit_member', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            userId: userId,
            name: name,
            phone: phone,
            address: address,
            address2: address2
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // å†æ›´æ–°ç‹€æ…‹
            updateMemberStatus(userId, status, true);
        } else {
            alert('æ›´æ–°å¤±æ•—: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('æ›´æ–°å‡ºéŒ¯');
    });
}

// æ›´æ–°æœƒå“¡ç‹€æ…‹
function updateMemberStatus(userId, status, isFromEdit = false) {
    fetch('/api/admin/member/update_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            userId: userId,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (isFromEdit) {
                bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
                loadMembers();
                alert('æœƒå“¡è³‡æ–™å·²æ›´æ–°');
            } else {
                loadMembers();
            }
        } else {
            alert('æ›´æ–°å¤±æ•—: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('æ›´æ–°å‡ºéŒ¯');
    });
}

// è®Šæ›´æœƒå“¡ç‹€æ…‹ï¼ˆç¢ºèªå°è©±æ¡†ï¼‰
function changeStatus(userId, newStatus) {
    pendingAction = { userId: userId, status: newStatus };
    const member = allMembers.find(m => m.userId === userId);
    
    document.getElementById('confirm-message').textContent = 
        `ç¢ºèªè¦å°‡æœƒå“¡ ${member.name} (${userId}) çš„ç‹€æ…‹è®Šæ›´ç‚º ${newStatus} å—ï¼Ÿ`;
    
    document.getElementById('confirm-btn').className = 'btn ' + 
        (newStatus === 'é»‘åå–®' ? 'btn-danger' : 'btn-warning');
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

// ç¢ºèªæ“ä½œ
function confirmAction() {
    if (!pendingAction.userId) return;
    
    bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    updateMemberStatus(pendingAction.userId, pendingAction.status);
}

// å°å‡ºæœƒå“¡è³‡æ–™
function exportMembers() {
    window.location.href = '/api/admin/members/export';
}

// ===== æœƒå“¡ ID é©—è­‰å·¥å…· =====

/**
 * æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ LINE User ID
 * æ ¼å¼ï¼šU + 32 å€‹åå…­é€²åˆ¶å­—ç¬¦
 */
function isValidLineUserId(id) {
    if (!id) return false;
    const lineIdPattern = /^U[a-f0-9]{32}$/i;
    return lineIdPattern.test(id);
}

// ç”Ÿæˆé©—è­‰ä»¤ç‰Œ
function generateVerificationToken(userId) {
    const member = allMembers.find(m => m.userId === userId);
    if (!member) return;
    
    // å¡«å……é©—è­‰æ¨¡æ…‹çª—çš„ä¿¡æ¯
    document.getElementById('verify-user-id-display').textContent = userId;
    document.getElementById('verify-member-name').textContent = member.name;
    document.getElementById('verify-member-phone').textContent = member.phone;
    
    // å‘¼å«å¾Œç«¯ç”Ÿæˆé©—è­‰ä»¤ç‰Œ
    fetch('/api/admin/member/generate_verification_token', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ userId: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const verificationUrl = `${window.location.origin}/?page=verify&token=${data.token}`;
            document.getElementById('verification-link').value = verificationUrl;
            
            // åŠ è¼‰ Webhook æ—¥èªŒ
            loadWebhookLogs(userId);
            
            new bootstrap.Modal(document.getElementById('verificationModal')).show();
        } else {
            alert('ç”Ÿæˆé©—è­‰ä»¤ç‰Œå¤±æ•—: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç”Ÿæˆé©—è­‰ä»¤ç‰Œå‡ºéŒ¯');
    });
}

// æ‰‹å‹•æ›´æ–° User ID
function manuallyUpdateUserId() {
    const userId = document.getElementById('verify-user-id-display').textContent;
    const newUserId = document.getElementById('manual-user-id').value.trim();
    
    if (!newUserId) {
        alert('è«‹è¼¸å…¥ LINE User ID');
        return;
    }
    
    if (!isValidLineUserId(newUserId)) {
        alert('âŒ ç„¡æ•ˆçš„ LINE User ID æ ¼å¼\næ ¼å¼æ‡‰ç‚ºï¼šU + 32 å€‹åå…­é€²åˆ¶å­—ç¬¦');
        return;
    }
    
    if (!confirm(`ç¢ºèªè¦å°‡æœƒå“¡ ID å¾ ${userId} æ›´æ–°ç‚º ${newUserId} å—ï¼Ÿ`)) {
        return;
    }
    
    fetch('/api/admin/member/update_user_id', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            oldUserId: userId,
            newUserId: newUserId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('âœ… æœƒå“¡ ID å·²æ›´æ–°');
            bootstrap.Modal.getInstance(document.getElementById('verificationModal')).hide();
            loadMembers();
        } else {
            alert('âŒ æ›´æ–°å¤±æ•—: ' + data.msg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('æ›´æ–°å‡ºéŒ¯');
    });
}

// åŠ è¼‰ Webhook æ—¥èªŒ
function loadWebhookLogs(userId) {
    const logsDiv = document.getElementById('webhook-logs');
    
    fetch(`/api/admin/webhook_logs?userId=${userId}`, {
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.logs) {
            if (data.logs.length === 0) {
                logsDiv.innerHTML = '<p class="text-muted">æš«ç„¡æ—¥èªŒ</p>';
            } else {
                logsDiv.innerHTML = data.logs.map(log => `
                    <div style="margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #ccc;">
                        <strong>${log.timestamp}</strong><br>
                        äº‹ä»¶ï¼š${log.event}<br>
                        ${log.userId ? `LINE ID: ${log.userId}<br>` : ''}
                        <small style="color: #666;">${log.details || ''}</small>
                    </div>
                `).join('');
            }
        } else {
            logsDiv.innerHTML = '<p class="text-danger">è¼‰å…¥æ—¥èªŒå¤±æ•—</p>';
        }
    })
    .catch(error => {
        console.error('Error loading logs:', error);
        logsDiv.innerHTML = '<p class="text-danger">è¼‰å…¥æ—¥èªŒå‡ºéŒ¯</p>';
    });
}

// è¤‡è£½åˆ°å‰ªè²¼ç°¿
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
}

// è¼”åŠ©å‡½æ•¸
function getStatusIcon(status) {
    switch(status) {
        case 'å•Ÿç”¨': return 'âœ…';
        case 'åœç”¨': return 'â¸ï¸';
        case 'é»‘åå–®': return 'ğŸš«';
        default: return 'â€¢';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit'});
}
</script>

</body>
</html>
